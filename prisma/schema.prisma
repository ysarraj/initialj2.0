// InitialJ - Japanese Learning SaaS
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =====================================
// USER MANAGEMENT
// =====================================

enum Role {
  USER
  ADMIN
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String
  username      String?
  usernameHidden Boolean  @default(false)
  role          Role     @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscription  Subscription?
  kanjiProgress UserKanjiProgress[]
  vocabProgress UserVocabProgress[]
  settings      UserSettings?
  weeklyXP      WeeklyXP[]

  @@index([email])
  @@index([role])
}

model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String   // 4-digit code
  password  String   // Hashed password (stored temporarily)
  username  String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

// =====================================
// SUBSCRIPTION SYSTEM
// =====================================

enum Plan {
  FREE // N5 only
  MONTHLY // 3 USD/month - all levels
  YEARLY // 30 USD/year - all levels
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  plan                 Plan               @default(FREE)
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

// =====================================
// KANJI LEARNING SYSTEM
// =====================================

enum LessonType {
  HIRAGANA
  KATAKANA
  KANJI
}

model KanjiLesson {
  id          String     @id @default(cuid())
  level       Int        @unique // 1-100
  title       String // e.g., "Lesson 1: Basic Radicals"
  description String?
  lessonType  LessonType @default(KANJI) // Type of lesson: HIRAGANA, KATAKANA, or KANJI
  kanjiCount  Int        @default(0)
  vocabCount  Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  kanji      Kanji[]
  vocabulary Vocabulary[]

  @@index([level])
  @@index([lessonType])
}

model Kanji {
  id        String      @id @default(cuid())
  character String      @unique // The kanji character itself
  lessonId  String
  lesson    KanjiLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Readings stored as JSON arrays
  kunYomi String @default("[]") // Japanese readings
  onYomi  String @default("[]") // Chinese readings
  nanori  String @default("[]") // Name readings

  // Meanings
  meanings       String @default("[]") // JSON array of English meanings
  primaryMeaning String // Main meaning for reviews

  // Metadata
  grade       Int? // School grade (1-6 for Joyo, 8 for Jinmeiyo)
  jlpt        Int? // JLPT level (1-5, 1 being hardest)
  strokeCount Int?
  unicode     String? // Unicode code point

  // Mnemonics (user can customize)
  meaningMnemonic String?
  readingMnemonic String?

  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  vocabulary   KanjiVocabulary[]
  userProgress UserKanjiProgress[]

  @@index([lessonId])
  @@index([character])
  @@index([grade])
  @@index([jlpt])
}

model Vocabulary {
  id       String      @id @default(cuid())
  word     String // The vocabulary word (can contain kanji + kana)
  lessonId String
  lesson   KanjiLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  reading        String // Hiragana/katakana reading
  meanings       String @default("[]") // JSON array of English meanings
  primaryMeaning String // Main meaning for reviews

  // Part of speech and usage
  partOfSpeech String? // noun, verb, adjective, etc.
  sentences    String  @default("[]") // JSON array of example sentences

  // Mnemonics
  meaningMnemonic String?
  readingMnemonic String?

  // Audio (optional future feature)
  audioUrl String?

  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kanjiLinks   KanjiVocabulary[]
  userProgress UserVocabProgress[]

  @@unique([word, reading])
  @@index([lessonId])
  @@index([word])
}

// Many-to-many relationship between Kanji and Vocabulary
model KanjiVocabulary {
  id           String     @id @default(cuid())
  kanjiId      String
  kanji        Kanji      @relation(fields: [kanjiId], references: [id], onDelete: Cascade)
  vocabularyId String
  vocabulary   Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  @@unique([kanjiId, vocabularyId])
  @@index([kanjiId])
  @@index([vocabularyId])
}

// =====================================
// SRS PROGRESS TRACKING
// =====================================

// SRS Stages:
// 0: Not started
// 1: Apprentice 1 (4 hours)
// 2: Apprentice 2 (8 hours)
// 3: Apprentice 3 (1 day)
// 4: Apprentice 4 (2 days)
// 5: Guru 1 (1 week)
// 6: Guru 2 (2 weeks)
// 7: Master (1 month)
// 8: Enlightened (4 months)
// 9: Burned (complete)

model UserKanjiProgress {
  id      String @id @default(cuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  kanjiId String
  kanji   Kanji  @relation(fields: [kanjiId], references: [id], onDelete: Cascade)

  srsStage         Int @default(0) // 0-9
  meaningCorrect   Int @default(0)
  meaningIncorrect Int @default(0)
  readingCorrect   Int @default(0)
  readingIncorrect Int @default(0)

  unlockedAt     DateTime  @default(now())
  lastReviewedAt DateTime?
  nextReviewAt   DateTime?
  burnedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, kanjiId])
  @@index([userId])
  @@index([kanjiId])
  @@index([userId, srsStage])
  @@index([userId, nextReviewAt])
}

model UserVocabProgress {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabularyId String
  vocabulary   Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)

  srsStage         Int @default(0) // 0-9
  meaningCorrect   Int @default(0)
  meaningIncorrect Int @default(0)
  readingCorrect   Int @default(0)
  readingIncorrect Int @default(0)

  unlockedAt     DateTime  @default(now())
  lastReviewedAt DateTime?
  nextReviewAt   DateTime?
  burnedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, vocabularyId])
  @@index([userId])
  @@index([vocabularyId])
  @@index([userId, srsStage])
  @@index([userId, nextReviewAt])
}

// Track overall user progress and settings
model UserSettings {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentLevel      Int      @default(1) // Current lesson level unlocked
  lessonsPerDay     Int      @default(20) // Max new items per day
  reviewsPerSession Int      @default(100) // Max reviews per session
  autoplayAudio     Boolean  @default(true)
  showMnemonics     Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
}

// Weekly XP tracking for leaderboard
model WeeklyXP {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weekStart DateTime // Monday of the week (ISO week)
  weekEnd   DateTime // Sunday of the week
  xp        Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, weekStart])
  @@index([userId])
  @@index([weekStart])
  @@index([weekStart, xp])
}
